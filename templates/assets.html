{% extends "base.html" %}

{% block title %}ZENTRA - إدارة الأصول{% endblock %}
{% block page_title %}إدارة الأصول{% endblock %}

{% block extra_head %}
<style>
/* ── Stats Cards ─────────────────────────────────────── */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 20px;
}
.stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 18px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    box-shadow: var(--shadow-sm);
}
.stat-icon {
    width: 46px; height: 46px;
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
}
.stat-icon.total       { background:#edf2f7; color:#2d3748; }
.stat-icon.available   { background:#d1fae5; color:#065f46; }
.stat-icon.in-use      { background:#dbeafe; color:#1e40af; }
.stat-icon.maintenance { background:#fef3c7; color:#92400e; }
.stat-label { font-size:12px; color:var(--text-muted); font-family:'Cairo',sans-serif; font-weight:700; }
.stat-value { font-size:26px; font-weight:800; color:var(--text-primary); font-family:'Cairo',sans-serif; line-height:1; }

/* ── Toolbar ─────────────────────────────────────────── */
.assets-toolbar {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 14px 20px;
    margin-bottom: 16px;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    box-shadow: var(--shadow-sm);
}
.search-box {
    flex: 1; min-width: 180px;
    display: flex; align-items: center;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    overflow: hidden;
    height: 36px;
}
.search-box i { padding: 0 10px; color: var(--text-muted); }
.search-box input {
    border: none; outline: none; flex: 1;
    font-family:'Cairo',sans-serif; font-weight:700;
    font-size:13px; padding: 0 8px;
    background: transparent; direction: rtl;
}
.toolbar-select {
    height:36px; padding:0 10px;
    border:1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-family:'Cairo',sans-serif; font-weight:700; font-size:13px;
    background: var(--bg-primary);
    direction: rtl;
}
.btn-primary { background:#2d3748; color:#fff; }
.btn-primary:hover { background:#1a202c; }
.btn-success { background:#065f46; color:#fff; }
.btn-success:hover { background:#064e3b; }
.btn-outline {
    background: transparent; color: var(--text-secondary);
    border: 1px solid var(--border-color);
}
.btn-outline:hover { background: var(--bg-secondary); color: var(--text-primary); }

/* ── Table ───────────────────────────────────────────── */
.assets-table-wrap {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
}
.assets-table { width:100%; border-collapse:collapse; }
.assets-table thead { background: var(--bg-secondary); }
.assets-table th {
    padding: 12px 16px; text-align: right;
    font-size:12px; font-weight:800; color:var(--text-secondary);
    font-family:'Cairo',sans-serif; letter-spacing:.5px;
    border-bottom: 1px solid var(--border-color); white-space:nowrap;
}
.assets-table td {
    padding:14px 16px; font-size:13px; font-family:'Cairo',sans-serif;
    font-weight:700; color:var(--text-primary);
    border-bottom: 1px solid var(--border-light); vertical-align:middle;
}
.assets-table tbody tr:last-child td { border-bottom:none; }
.assets-table tbody tr:hover { background: var(--bg-secondary); }
.asset-link { text-decoration:none; color:var(--text-primary); font-weight:800; }
.asset-link:hover { color: #2d3748; text-decoration:underline; }
.asset-tag {
    display:inline-block; padding:3px 8px;
    background:#edf2f7; border-radius:4px;
    font-size:12px; font-weight:800; color:#2d3748;
    font-family: monospace; letter-spacing:.5px;
}

/* Status badges */
.abadge {
    display:inline-block; padding:4px 10px; border-radius:var(--radius-full);
    font-size:11px; font-weight:800; font-family:'Cairo',sans-serif;
    white-space:nowrap;
}
.abadge-available   { background:#d1fae5; color:#065f46; border:1px solid #6ee7b7; }
.abadge-inuse       { background:#dbeafe; color:#1e40af; border:1px solid #93c5fd; }
.abadge-maintenance { background:#fef3c7; color:#92400e; border:1px solid #fcd34d; }
.abadge-retired     { background:#f3f4f6; color:#6b7280; border:1px solid #d1d5db; }
.abadge-lost        { background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }

/* Condition dots */
.cond-dot {
    display:inline-block; width:8px; height:8px;
    border-radius:50%; margin-left:5px;
}
.cond-good    { background:#10b981; }
.cond-fair    { background:#f59e0b; }
.cond-poor    { background:#ef4444; }
.cond-damaged { background:#6b7280; }

/* Action buttons */
.action-btn {
    width:30px; height:30px; border-radius: var(--radius-md);
    display:inline-flex; align-items:center; justify-content:center;
    text-decoration:none; font-size:13px; border:none; cursor:pointer;
    transition: var(--transition-fast);
}
.action-btn.view   { background:#edf2f7; color:#2d3748; }
.action-btn.edit   { background:#dbeafe; color:#1e40af; }
.action-btn.delete { background:#fee2e2; color:#991b1b; }
.action-btn:hover  { opacity:.8; transform:scale(1.08); }

/* Empty state */
.empty-state { padding:60px 30px; text-align:center; color:var(--text-muted); }
.empty-state i { font-size:48px; margin-bottom:16px; display:block; }
.empty-state h3 { font-family:'Cairo',sans-serif; font-weight:700; color:var(--text-primary); margin-bottom:8px; }

/* Pagination */
.assets-pagination {
    padding: 16px 20px;
    border-top: 1px solid var(--border-light);
    display:flex; align-items:center; justify-content:space-between;
    flex-wrap:wrap; gap:10px; background:var(--bg-secondary);
}

@media (max-width:768px) {
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .assets-toolbar { flex-direction:column; align-items:stretch; }
    .search-box { min-width:100%; }
    .assets-table th:nth-child(n+5), .assets-table td:nth-child(n+5) { display:none; }
}
</style>
{% endblock %}

{% block content %}

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon total"><i class="fas fa-boxes"></i></div>
        <div>
            <div class="stat-label">إجمالي الأصول</div>
            <div class="stat-value">{{ stats.total }}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon available"><i class="fas fa-check-circle"></i></div>
        <div>
            <div class="stat-label">متاح</div>
            <div class="stat-value">{{ stats.available }}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon in-use"><i class="fas fa-desktop"></i></div>
        <div>
            <div class="stat-label">قيد الاستخدام</div>
            <div class="stat-value">{{ stats.in_use }}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon maintenance"><i class="fas fa-tools"></i></div>
        <div>
            <div class="stat-label">تحت الصيانة</div>
            <div class="stat-value">{{ stats.maintenance }}</div>
        </div>
    </div>
</div>

<!-- Toolbar -->
<form method="GET" action="{{ url_for('assets_list') }}">
<div class="assets-toolbar">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" name="search" placeholder="بحث بالرقم، الاسم، الـ IP ..." value="{{ search }}">
    </div>

    <select name="category" class="toolbar-select">
        <option value="">كل الفئات</option>
        {% for cat in categories %}
        <option value="{{ cat }}" {% if cat_filter == cat %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
    </select>

    <select name="status" class="toolbar-select">
        <option value="">كل الحالات</option>
        {% for st in statuses %}
        <option value="{{ st }}" {% if stat_filter == st %}selected{% endif %}>{{ st }}</option>
        {% endfor %}
    </select>

    <select name="room" class="toolbar-select">
        <option value="">كل الغرف</option>
        {% for r in rooms %}
        <option value="{{ r }}" {% if room_filter == r %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
    </select>

    <button type="submit" class="btn btn-primary">
        <i class="fas fa-filter"></i> بحث
    </button>

    {% if search or cat_filter or stat_filter or room_filter %}
    <a href="{{ url_for('assets_list') }}" class="btn btn-outline">
        <i class="fas fa-times"></i> مسح
    </a>
    {% endif %}

    <div style="flex:1;"></div>

    <a href="{{ url_for('assets_export') }}" class="btn btn-outline">
        <i class="fas fa-file-csv"></i> تصدير CSV
    </a>
    <a href="{{ url_for('asset_create') }}" class="btn btn-success">
        <i class="fas fa-plus"></i> أصل جديد
    </a>
</div>
</form>

<!-- Table -->
<div class="assets-table-wrap">
    {% if assets %}
    <table class="assets-table">
        <thead>
            <tr>
                <th>رقم الأصل</th>
                <th>الاسم / الفئة</th>
                <th>الحالة</th>
                <th>الحالة الجسمية</th>
                <th>الغرفة</th>
                <th>مُسند إلى</th>
                <th>IP</th>
                <th>الضمان حتى</th>
                <th>إجراءات</th>
            </tr>
        </thead>
        <tbody>
        {% for asset in assets %}
        <tr>
            <td>
                <a href="{{ url_for('asset_detail', asset_id=asset.id) }}" class="asset-link">
                    <span class="asset-tag">{{ asset.asset_tag }}</span>
                </a>
            </td>
            <td>
                <div style="font-weight:800;">{{ asset.name }}</div>
                <div style="font-size:11px;color:var(--text-muted);">{{ asset.category }}{% if asset.brand %} · {{ asset.brand }}{% endif %}</div>
            </td>
            <td>
                {% set smap = {'Available':'available','In Use':'inuse','Under Maintenance':'maintenance','Retired':'retired','Lost':'lost'} %}
                <span class="abadge abadge-{{ smap.get(asset.status, 'available') }}">{{ asset.status }}</span>
            </td>
            <td>
                {% set cmap = {'Good':'good','Fair':'fair','Poor':'poor','Damaged':'damaged'} %}
                <span class="cond-dot cond-{{ cmap.get(asset.condition, 'good') }}"></span>{{ asset.condition }}
            </td>
            <td>{{ asset.room or '—' }}</td>
            <td>{{ asset.assigned_to.full_name if asset.assigned_to else '—' }}</td>
            <td style="font-family:monospace;font-size:12px;">{{ asset.ip_address or '—' }}</td>
            <td>
                {% if asset.warranty_until %}
                    {% set today = namespace(d=None) %}
                    <span style="font-size:12px;">{{ asset.warranty_until.strftime('%Y-%m-%d') }}</span>
                {% else %}—{% endif %}
            </td>
            <td>
                <div style="display:flex;gap:5px;align-items:center;">
                    <a href="{{ url_for('asset_detail', asset_id=asset.id) }}" class="action-btn view" title="عرض"><i class="fas fa-eye"></i></a>
                    <a href="{{ url_for('asset_edit', asset_id=asset.id) }}" class="action-btn edit" title="تعديل"><i class="fas fa-pen"></i></a>
                    {% if current_user.role == 'admin' %}
                    <form method="POST" action="{{ url_for('asset_delete', asset_id=asset.id) }}"
                          onsubmit="return confirm('حذف هذا الأصل نهائياً؟');" style="margin:0;">
                        <button type="submit" class="action-btn delete" title="حذف"><i class="fas fa-trash"></i></button>
                    </form>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="assets-pagination">
        <div class="page-info">
            صفحة {{ pagination.page }} من {{ pagination.pages }} ({{ pagination.total }} أصل)
        </div>
        <nav class="pagination">
            {% if pagination.has_prev %}
            <a href="{{ url_for('assets_list', page=pagination.prev_num, search=search, category=cat_filter, status=stat_filter, room=room_filter) }}" class="page-link"><i class="fas fa-chevron-right"></i></a>
            {% else %}
            <span class="page-link disabled"><i class="fas fa-chevron-right"></i></span>
            {% endif %}

            {% for pn in pagination.iter_pages(left_edge=1,right_edge=1,left_current=1,right_current=2) %}
                {% if pn %}
                    {% if pn == pagination.page %}
                    <span class="page-link active">{{ pn }}</span>
                    {% else %}
                    <a href="{{ url_for('assets_list', page=pn, search=search, category=cat_filter, status=stat_filter, room=room_filter) }}" class="page-link">{{ pn }}</a>
                    {% endif %}
                {% else %}
                <span class="page-link disabled">...</span>
                {% endif %}
            {% endfor %}

            {% if pagination.has_next %}
            <a href="{{ url_for('assets_list', page=pagination.next_num, search=search, category=cat_filter, status=stat_filter, room=room_filter) }}" class="page-link"><i class="fas fa-chevron-left"></i></a>
            {% else %}
            <span class="page-link disabled"><i class="fas fa-chevron-left"></i></span>
            {% endif %}
        </nav>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <i class="fas fa-box-open"></i>
        <h3>لا توجد أصول</h3>
        <p>{% if search or cat_filter or stat_filter %}جرّب تعديل فلاتر البحث أو {% endif %}
           <a href="{{ url_for('asset_create') }}" style="color:#2d3748;font-weight:800;">أضف أصلاً جديداً</a>
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}